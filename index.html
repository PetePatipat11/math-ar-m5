<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AR Geometry Learning</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        /* ‡πÅ‡∏Å‡πâ‡∏†‡∏≤‡∏û‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏° */
        video { transform: scaleX(1) !important; }
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; touch-action: none; font-family: 'Sarabun', sans-serif; }
        .bg-gradient { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); z-index: -2; opacity: 0.6; }

        /* UI Styles */
        #intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); }
        .glass-card { background: rgba(255, 255, 255, 0.95); padding: 30px 20px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); text-align: center; max-width: 420px; width: 100%; border: 1px solid rgba(255, 255, 255, 0.8); overflow-y: auto; max-height: 95vh; }
        .app-header { margin-bottom: 20px; }
        .app-logo { font-size: 50px; margin-bottom: 5px; display: inline-block; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
        h1 { margin: 0; color: #2c3e50; font-size: 26px; font-weight: 800; }
        p { margin: 5px 0 0 0; color: #666; font-size: 14px; }
        .section-title { text-align: left; font-size: 14px; font-weight: bold; color: #555; margin: 15px 5px 5px 5px; }
        .main-menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .menu-btn { background: #fff; border: 2px solid #f0f0f0; padding: 15px 5px; border-radius: 20px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 5px rgba(0,0,0,0.03); }
        .menu-btn:hover { border-color: #23a6d5; background: #e0f7fa; transform: translateY(-3px); }
        .menu-icon { font-size: 32px; margin-bottom: 5px; }
        .menu-title { font-weight: bold; font-size: 16px; color: #333; }
        .menu-desc { font-size: 12px; color: #888; }
        .resource-btn { width: 100%; padding: 12px; margin-bottom: 8px; background: white; border: 1px solid #ddd; border-radius: 15px; display: flex; align-items: center; gap: 15px; text-align: left; cursor: pointer; transition: 0.2s; box-sizing: border-box; }
        .res-icon { width: 40px; height: 40px; background: #eee; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        .res-text h3 { margin: 0; font-size: 15px; color: #333; }
        .res-text span { font-size: 12px; color: #888; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .video-container { width: 90%; max-width: 600px; aspect-ratio: 16/9; background: black; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .formula-box { background: white; width: 85%; max-width: 450px; padding: 25px; border-radius: 25px; text-align: left; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.3); margin-top: auto; margin-bottom: 80px; transition: 0.3s; }
        #formula-modal { background: rgba(0,0,0,0.1); pointer-events: none; }
        #formula-modal .formula-box { pointer-events: auto; }
        .formula-title { font-size: 22px; font-weight: 800; color: #2c3e50; margin-bottom: 5px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .formula-desc { font-size: 13px; color: #666; margin-bottom: 15px; font-style: italic; background: #f0f0f0; padding: 8px; border-radius: 8px; }
        .formula-item { margin-bottom: 20px; }
        .formula-label { font-size: 14px; color: #888; font-weight: bold; margin-bottom: 5px;}
        .formula-math-container { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 8px 12px; border-radius: 8px; border: 1px solid #eee; }
        .formula-math { flex-grow: 1; font-size: 18px; color: #333; font-family: 'Times New Roman', serif; overflow-wrap: break-word;}
        .formula-input, .formula-select { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 12px; font-family: 'Sarabun', sans-serif; box-sizing: border-box; margin-bottom: 15px; transition: 0.3s; }
        .formula-input { font-family: 'Times New Roman', serif; font-style: italic; }
        .formula-input:focus, .formula-select:focus { border-color: #23a6d5; outline: none; }
        
        .edit-actions { text-align: right; }
        .btn-small { padding: 5px 10px; margin-left: 5px; border: none; border-radius: 15px; font-size: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-edit { background: #e1e1e1; color: #333; }
        .btn-save { background: #2ed573; color: white; }
        .btn-cancel { background: #ff4757; color: white; }
        .hidden { display: none !important; }
        .close-modal-btn { margin-top: 10px; padding: 12px 30px; border-radius: 50px; border: none; background: #333; color: white; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; transition: 0.2s;}
        .btn-submit-blue { background: #23a6d5; }

        /* UI ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Gallery & AR */
        #gallery-ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: none; pointer-events: none; }
        #top-bar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; pointer-events: auto; }
        #model-name-box { background: rgba(255,255,255,0.95); padding: 10px 25px; border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: inline-block; }
        #model-name { font-size: 20px; font-weight: 800; color: #333; }
        #bottom-controls { position: absolute; bottom: 30px; width: 100%; text-align: center; pointer-events: auto; }
        .ctrl-group { background: rgba(255,255,255,0.95); padding: 8px; border-radius: 40px; display: inline-flex; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 15px; align-items: center;}
        .btn-ctrl { width: 50px; height: 50px; border-radius: 50%; border: none; background: #f1f2f6; font-size: 22px; cursor: pointer; color: #333; }
        .btn-formula { width: 50px; height: 50px; border-radius: 50%; border: none; background: #feca57; font-size: 24px; cursor: pointer; color: #333; box-shadow: 0 4px 10px rgba(254, 202, 87, 0.4); }
        .btn-student-input { width: 50px; height: 50px; border-radius: 50%; border: none; background: #48dbfb; font-size: 24px; cursor: pointer; color: #333; box-shadow: 0 4px 10px rgba(72, 219, 251, 0.4); }
        #btn-open-ar { background: #2ed573; color: white; border: none; padding: 15px 40px; font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 20px rgba(46, 213, 115, 0.4); pointer-events: auto; }
        #ar-ui { position: fixed; bottom: 30px; left: 0; width: 100%; text-align: center; z-index: 2000; display: none; pointer-events: none; }
        #ar-ui button { pointer-events: auto; } /* ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏∞‡∏•‡∏∏‡∏ú‡πà‡∏≤‡∏ô */
        #btn-close-ar { background: #ff4757; color: white; padding: 12px 35px; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4); }
        
        #btn-sound-toggle {
            background: #ffffff; color: #333; width: 50px; height: 50px; border-radius: 50%; border: none; 
            font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            display: none; position: absolute; right: 20px; bottom: 100px; z-index: 2005; pointer-events: auto;
        }

        #ar-guide { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(0,0,0,0.7); color: white; padding: 12px; border-radius: 30px; text-align: center; z-index: 2000; display: none; backdrop-filter: blur(5px); pointer-events: none; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; color: white; justify-content: center; align-items: center; font-size: 20px; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #2ed573; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script>
        // --- 1. Gesture Detector (‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡∏ô‡∏¥‡πâ‡∏ß) ---
        AFRAME.registerComponent("gesture-detector", {
            schema: { element: { default: "" } },
            init: function() {
                this.targetElement = this.data.element && document.querySelector(this.data.element);
                if (!this.targetElement) { this.targetElement = this.el; }
                this.internalState = { previousState: null };
                this.emitGestureEvent = this.emitGestureEvent.bind(this);
                this.targetElement.addEventListener("touchstart", this.emitGestureEvent);
                this.targetElement.addEventListener("touchend", this.emitGestureEvent);
                this.targetElement.addEventListener("touchmove", this.emitGestureEvent);
            },
            remove: function() {
                this.targetElement.removeEventListener("touchstart", this.emitGestureEvent);
                this.targetElement.removeEventListener("touchend", this.emitGestureEvent);
                this.targetElement.removeEventListener("touchmove", this.emitGestureEvent);
            },
            emitGestureEvent: function(event) {
                const currentState = this.getTouchState(event);
                const previousState = this.internalState.previousState;
                const gestureContinues = previousState && currentState && currentState.touchCount == previousState.touchCount;
                if (gestureContinues) {
                    const eventDetail = { positionChange: { x: currentState.position.x - previousState.position.x, y: currentState.position.y - previousState.position.y } };
                    if (currentState.spread) { eventDetail.spreadChange = currentState.spread - previousState.spread; }
                    const eventName = (currentState.touchCount === 2) ? "twofingermove" : "onefingermove";
                    this.el.emit(eventName, eventDetail);
                    this.internalState.previousState = currentState;
                }
                if (currentState && !gestureContinues) { this.internalState.previousState = currentState; }
                if (!currentState) { this.internalState.previousState = null; }
            },
            getTouchState: function(event) {
                if (event.touches.length === 0) return null;
                const touchList = [];
                for (let i = 0; i < event.touches.length; i++) { touchList.push({ x: event.touches[i].clientX, y: event.touches[i].clientY }); }
                const center = touchList.reduce((a, b) => ({ x: a.x + b.x, y: a.y + b.y }));
                center.x /= touchList.length; center.y /= touchList.length;
                let spread = null;
                if (touchList.length >= 2) {
                    const dx = touchList[0].x - touchList[1].x;
                    const dy = touchList[0].y - touchList[1].y;
                    spread = Math.sqrt(dx * dx + dy * dy);
                }
                return { touchCount: touchList.length, position: center, spread: spread };
            }
        });

        // --- 2. Gesture Handler (‡∏ï‡∏±‡∏ß‡∏ã‡∏π‡∏°‡∏â‡∏ö‡∏±‡∏ö Mobile-Friendly) ---
        // üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ã‡∏π‡∏°‡πÇ‡∏î‡∏¢‡∏Ñ‡∏π‡∏ì‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Incremental) ‡∏ï‡∏±‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏î‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ã‡∏π‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ üî•
        AFRAME.registerComponent("gesture-handler", {
            schema: { minScale: { default: 0.1 }, maxScale: { default: 8 } },
            init: function() {
                this.handleScale = this.handleScale.bind(this);
                this.el.sceneEl.addEventListener("twofingermove", this.handleScale);
            },
            remove: function() { this.el.sceneEl.removeEventListener("twofingermove", this.handleScale); },
            handleScale: function(event) {
                const spreadChange = event.detail.spreadChange;
                if (!spreadChange) return;
                
                // ‡∏™‡∏π‡∏ï‡∏£‡∏ã‡∏π‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î
                const sensitivity = 0.005; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß
                const scaleMultiplier = 1 + (spreadChange * sensitivity);
                
                const currentScale = this.el.object3D.scale;
                const newScale = currentScale.x * scaleMultiplier;

                // ‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
                if (newScale >= this.data.minScale && newScale <= this.data.maxScale) {
                    this.el.object3D.scale.set(newScale, newScale, newScale);
                }
            }
        });
    </script>
</head>
<body>

    <div class="bg-gradient"></div>
    <div id="loading"><div class="spinner"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div>

    <div id="intro-screen">
        <div class="glass-card">
            <div class="app-header">
                <div class="app-logo">üßä</div>
                <h1>AR Geometry</h1>
                <p>‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï 3 ‡∏°‡∏¥‡∏ï‡∏¥</p>
            </div>
            <div class="section-title">üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
            <div class="main-menu-grid">
                <div class="menu-btn" onclick="enterGallery()">
                    <div class="menu-icon">üëÄ</div>
                    <div class="menu-title">‡πÇ‡∏´‡∏°‡∏î 3D</div>
                    <div class="menu-desc">‡∏´‡∏°‡∏∏‡∏ô‡∏î‡∏π‡πÇ‡∏°‡πÄ‡∏î‡∏•</div>
                </div>
                <div class="menu-btn" onclick="enterARDirectly()">
                    <div class="menu-icon">üì∑</div>
                    <div class="menu-title">‡πÇ‡∏´‡∏°‡∏î AR</div>
                    <div class="menu-desc">‡∏™‡πà‡∏≠‡∏á Marker</div>
                </div>
            </div>
            <div class="section-title">üìö ‡∏™‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡∏¥‡∏°</div>
            <div class="resource-btn" onclick="openVideoModal()">
                <div class="res-icon" style="color: #ff0000;">üì∫</div>
                <div class="res-text"><h3>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3><span>‡∏ä‡∏°‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</span></div>
            </div>
            <div class="resource-btn" onclick="openBookLink()">
                <div class="res-icon" style="color: #4CAF50;">üìñ</div>
                <div class="res-text"><h3>‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3><span>‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span></div>
            </div>
        </div>
    </div>

    <div id="video-modal" class="modal-overlay">
        <div class="video-container">
            <iframe id="youtube-frame" width="100%" height="100%" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
        <button class="close-modal-btn" style="width:auto; border:1px solid white; background:transparent;" onclick="closeVideoModal()">‚ùå ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
    </div>

    <div id="student-input-modal" class="modal-overlay">
        <div class="formula-box" style="margin-top: 0; margin-bottom: 0;">
            <div class="formula-title" style="color: #23a6d5;">üìù ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏π‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
            <div class="formula-item">
                <label for="student-shape-select" class="formula-label">üî∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á:</label>
                <select id="student-shape-select" class="formula-select"></select>
            </div>
            <div class="formula-item">
                 <label for="student-area-input" class="formula-label">üìê ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß (Surface Area):</label>
                 <input type="text" id="student-area-input" class="formula-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 4 * pi * r^2">
            </div>
            <div class="formula-item">
                 <label for="student-vol-input" class="formula-label">üßä ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (Volume):</label>
                 <input type="text" id="student-vol-input" class="formula-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô (4/3) * pi * r^3">
            </div>
            <button class="close-modal-btn btn-submit-blue" onclick="submitStudentFormulas()">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
            <button class="close-modal-btn" style="background: #ff4757; margin-top: 10px;" onclick="closeStudentInputModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <div id="formula-modal" class="modal-overlay">
        <div class="formula-box">
            <div id="formula-title" class="formula-title">...</div>
            <div id="formula-desc-container" class="formula-desc">üí° <span id="formula-desc-text">...</span></div>
            <div class="formula-item">
                <div class="formula-label">üìê ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß (Surface Area)</div>
                <div id="area-display-group" class="formula-math-container">
                    <span id="formula-area-text" class="formula-math">...</span>
                    <button class="btn-small btn-edit db-edit-btn" onclick="enableEditMode('area')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
                <div id="area-edit-group" class="hidden db-edit-group">
                    <input type="text" id="area-input" class="formula-input" style="margin-bottom: 5px;">
                    <div class="edit-actions">
                        <button class="btn-small btn-save" onclick="saveFormula('area')">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button class="btn-small btn-cancel" onclick="cancelEdit('area')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>
            <div class="formula-item">
                <div class="formula-label">üßä ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (Volume)</div>
                <div id="volume-display-group" class="formula-math-container">
                    <span id="formula-volume-text" class="formula-math">...</span>
                    <button class="btn-small btn-edit db-edit-btn" onclick="enableEditMode('volume')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
                <div id="volume-edit-group" class="hidden db-edit-group">
                    <input type="text" id="volume-input" class="formula-input" style="margin-bottom: 5px;">
                    <div class="edit-actions">
                        <button class="btn-small btn-save" onclick="saveFormula('volume')">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button class="btn-small btn-cancel" onclick="cancelEdit('volume')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>
            <button class="close-modal-btn" onclick="closeFormulaModal()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <div id="ar-guide">üì∑ <b>‡∏™‡πà‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î</b><br><span>(‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏∞‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ / ‡πÉ‡∏ä‡πâ‡∏ô‡∏¥‡πâ‡∏ß‡∏ã‡∏π‡∏°‡πÑ‡∏î‡πâ)</span></div>

    <button id="btn-sound-toggle" onclick="toggleSound()">üîä</button>

    <div id="gallery-ui">
        <div id="top-bar"><div id="model-name-box"><span id="model-name">...</span></div></div>
        <div id="bottom-controls">
            <div class="ctrl-group">
                <button class="btn-ctrl" onclick="prevModel()">‚óÄ</button>
                <button class="btn-ctrl" onclick="enterMenu()">üè†</button>
                <button class="btn-formula" onclick="openFormula()" title="‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏â‡∏•‡∏¢">üìê</button>
                <button class="btn-student-input" onclick="openStudentInputModal()" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏≠‡∏á">üìù</button>
                <button class="btn-ctrl" onclick="nextModel()">‚ñ∂</button>
            </div>
            <br><button id="btn-open-ar" onclick="startAR()">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button>
        </div>
    </div>

    <div id="ar-ui"><button id="btn-close-ar" onclick="stopAR()">‚ùå ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button></div>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: no; uiError: no; uiScanning: no; filterMinCF: 0.0001; missTolerance: 10;" 
             color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false"
             gesture-detector> 
        
        <a-assets>
            <a-asset-item id="glb-1" src="./m1.glb"></a-asset-item>
            <a-asset-item id="glb-2" src="./m2.glb"></a-asset-item>
            <a-asset-item id="glb-3" src="./m3.glb"></a-asset-item>
            <a-asset-item id="glb-4" src="./m4.glb"></a-asset-item>
            <a-asset-item id="glb-5" src="./m5.glb"></a-asset-item>
            <a-asset-item id="glb-6" src="./m6.glb"></a-asset-item>
            <a-asset-item id="glb-7" src="./m7.glb"></a-asset-item>
        </a-assets>

        <a-light type="ambient" intensity="1.2"></a-light>
        <a-light type="directional" position="2 4 2" intensity="0.8"></a-light>

        <a-camera position="0 0 0" look-controls="enabled: false">
            <a-entity id="gallery-group" position="0 -0.5 -3" visible="true">
                <a-gltf-model id="view-m1" src="#glb-1" scale="0.5 0.5 0.5" visible="true" animation="property: rotation; to: 0 360 0; dur: 8000; loop: true"></a-gltf-model>
                <a-gltf-model id="view-m2" src="#glb-2" scale="0.5 0.5 0.5" visible="false" animation="property: rotation; to: 0 360 0; dur: 8000; loop: true"></a-gltf-model>
                <a-gltf-model id="view-m3" src="#glb-3" scale="0.5 0.5 0.5" visible="false" animation="property: rotation; to: 0 360 0; dur: 8000; loop: true"></a-gltf-model>
                <a-gltf-model id="view-m4" src="#glb-4" scale="0.5 0.5 0.5" visible="false" animation="property: rotation; to: 0 360 0; dur: 8000; loop: true"></a-gltf-model>
                <a-gltf-model id="view-m5" src="#glb-5" scale="0.5 0.5 0.5" visible="false" animation="property: rotation; to: 0 360 0; dur: 8000; loop: true"></a-gltf-model>
                <a-gltf-model id="view-m6" src="#glb-6" scale="0.5 0.5 0.5" visible="false" animation="property: rotation; to: 0 360 0; dur: 8000; loop: true"></a-gltf-model>
                <a-gltf-model id="view-m7" src="#glb-7" scale="0.5 0.5 0.5" visible="false" animation="property: rotation; to: 0 360 0; dur: 8000; loop: true"></a-gltf-model>
            </a-entity>
        </a-camera>

        <a-entity id="ar-group" visible="false">
            <a-entity mindar-image-target="targetIndex: 0"><a-gltf-model src="#glb-1" scale="0.5 0.5 0.5" position="0 0 0" gesture-handler></a-gltf-model></a-entity>
            <a-entity mindar-image-target="targetIndex: 1"><a-gltf-model src="#glb-2" scale="0.5 0.5 0.5" position="0 0 0" gesture-handler></a-gltf-model></a-entity>
            <a-entity mindar-image-target="targetIndex: 2"><a-gltf-model src="#glb-3" scale="0.5 0.5 0.5" position="0 0 0" gesture-handler></a-gltf-model></a-entity>
            <a-entity mindar-image-target="targetIndex: 3"><a-gltf-model src="#glb-4" scale="0.5 0.5 0.5" position="0 0 0" gesture-handler></a-gltf-model></a-entity>
            <a-entity mindar-image-target="targetIndex: 4"><a-gltf-model src="#glb-5" scale="0.5 0.5 0.5" position="0 0 0" gesture-handler></a-gltf-model></a-entity>
            <a-entity mindar-image-target="targetIndex: 5"><a-gltf-model src="#glb-6" scale="0.5 0.5 0.5" position="0 0 0" gesture-handler></a-gltf-model></a-entity>
            <a-entity mindar-image-target="targetIndex: 6"><a-gltf-model src="#glb-7" scale="0.5 0.5 0.5" position="0 0 0" gesture-handler></a-gltf-model></a-entity>
        </a-entity>
    </a-scene>

    <script>
        // --- üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏ï‡∏£ + ‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô (Speech) ---
        let geometryData = [
            { 
                name: "‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏®‡∏Å‡πå (Cube)", 
                area: "6s<sup>2</sup>", vol: "s<sup>3</sup>", desc: "s = ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏î‡πâ‡∏≤‡∏ô (Side)",
                speech: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ ‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏®‡∏Å‡πå, ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏Ñ‡∏∑‡∏≠ ‡∏´‡∏Å ‡∏Ñ‡∏π‡∏ì ‡∏î‡πâ‡∏≤‡∏ô‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á, ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ñ‡∏∑‡∏≠ ‡∏î‡πâ‡∏≤‡∏ô‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏°"
            },
            { 
                name: "‡∏ó‡∏£‡∏á‡∏Å‡∏•‡∏° (Sphere)", 
                area: "4œÄr<sup>2</sup>", vol: "4/3 √ó œÄr<sup>3</sup>", desc: "r = ‡∏£‡∏±‡∏®‡∏°‡∏µ (Radius), œÄ ‚âà 3.14",
                speech: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ ‡∏ó‡∏£‡∏á‡∏Å‡∏•‡∏°, ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏Ñ‡∏∑‡∏≠ ‡∏™‡∏µ‡πà ‡∏û‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏£‡πå ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á, ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏®‡∏©‡∏™‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏° ‡∏û‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏£‡πå ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏°"
            },
            { 
                name: "‡∏ó‡∏£‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å (Cylinder)", 
                area: "2œÄrh + 2œÄr<sup>2</sup>", vol: "œÄr<sup>2</sup>h", desc: "r = ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ê‡∏≤‡∏ô, h = ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á",
                speech: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ ‡∏ó‡∏£‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å, ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏Ñ‡∏∑‡∏≠ ‡∏™‡∏≠‡∏á ‡∏û‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏£‡πå ‡πÄ‡∏≠‡∏ä ‡∏ö‡∏ß‡∏Å ‡∏™‡∏≠‡∏á ‡∏û‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏£‡πå ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á, ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ñ‡∏∑‡∏≠ ‡∏û‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏£‡πå ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á ‡πÄ‡∏≠‡∏ä"
            },
            { 
                name: "‡∏Å‡∏£‡∏ß‡∏¢ (Cone)", 
                area: "œÄrl + œÄr<sup>2</sup>", vol: "1/3 √ó œÄr<sup>2</sup>h", desc: "r = ‡∏£‡∏±‡∏®‡∏°‡∏µ, h = ‡∏™‡∏π‡∏á‡∏ï‡∏£‡∏á, l = ‡∏™‡∏π‡∏á‡πÄ‡∏≠‡∏µ‡∏¢‡∏á",
                speech: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ ‡∏Å‡∏£‡∏ß‡∏¢, ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏Ñ‡∏∑‡∏≠ ‡∏û‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏£‡πå ‡πÅ‡∏≠‡∏• ‡∏ö‡∏ß‡∏Å ‡∏û‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏£‡πå ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á, ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏®‡∏©‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏° ‡∏û‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏£‡πå ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á ‡πÄ‡∏≠‡∏ä"
            },
            { 
                name: "‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô (Torus)", 
                area: "4œÄ<sup>2</sup>Rr", vol: "2œÄ<sup>2</sup>Rr<sup>2</sup>", desc: "R = ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ß‡∏á‡πÉ‡∏´‡∏ç‡πà, r = ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡πà‡∏≠‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏Å",
                speech: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏≠‡∏£‡∏±‡∏™, ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏Ñ‡∏∑‡∏≠ ‡∏™‡∏µ‡πà ‡∏û‡∏≤‡∏¢ ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á ‡∏≠‡∏≤‡∏£‡πå‡πÉ‡∏´‡∏ç‡πà ‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏•‡πá‡∏Å, ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ñ‡∏∑‡∏≠ ‡∏™‡∏≠‡∏á ‡∏û‡∏≤‡∏¢ ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á ‡∏≠‡∏≤‡∏£‡πå‡πÉ‡∏´‡∏ç‡πà ‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏•‡πá‡∏Å ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á"
            },
            { 
                name: "‡∏û‡∏µ‡∏£‡∏∞‡∏°‡∏¥‡∏î (Pyramid)", 
                area: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô + (1/2 √ó ‡∏£‡∏≠‡∏ö‡∏ê‡∏≤‡∏ô √ó l)", vol: "1/3 √ó ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô √ó h", desc: "h = ‡∏™‡∏π‡∏á‡∏ï‡∏£‡∏á, l = ‡∏™‡∏π‡∏á‡πÄ‡∏≠‡∏µ‡∏¢‡∏á",
                speech: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ ‡∏û‡∏µ‡∏£‡∏∞‡∏°‡∏¥‡∏î, ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏Ñ‡∏∑‡∏≠ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô ‡∏ö‡∏ß‡∏Å ‡πÄ‡∏®‡∏©‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≠‡∏á ‡∏Ñ‡∏π‡∏ì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏£‡∏≠‡∏ö‡∏ê‡∏≤‡∏ô ‡∏Ñ‡∏π‡∏ì ‡∏™‡∏π‡∏á‡πÄ‡∏≠‡∏µ‡∏¢‡∏á, ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏®‡∏©‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≤‡∏° ‡∏Ñ‡∏π‡∏ì ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô ‡∏Ñ‡∏π‡∏ì ‡∏™‡∏π‡∏á‡∏ï‡∏£‡∏á"
            },
            { 
                name: "‡∏ó‡∏£‡∏á 12 ‡∏´‡∏ô‡πâ‡∏≤ (Dodecahedron)", 
                area: "3 √ó ‚àö(25+10‚àö5) √ó s<sup>2</sup>", vol: "((15+7‚àö5)/4) √ó s<sup>3</sup>", desc: "s = ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏î‡πâ‡∏≤‡∏ô",
                speech: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ ‡∏ó‡∏£‡∏á‡∏™‡∏¥‡∏ö‡∏™‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÇ‡∏î‡πÄ‡∏î‡∏Ñ‡∏≤‡∏Æ‡∏µ‡∏î‡∏£‡∏≠‡∏ô, ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏î‡πâ‡∏≤‡∏ô‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏° ‡∏Ñ‡∏π‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà"
            }
        ];

        let currentIdx = 0;
        let isProcessing = false; 
        let arSystem = null;
        let isSoundOn = true; 
        const sceneEl = document.querySelector('a-scene');
        const loadingOverlay = document.getElementById('loading');
        
        sceneEl.addEventListener('loaded', () => { 
            arSystem = sceneEl.systems["mindar-image-system"]; 
            setupARListeners(); 
        });

        window.onload = function() {
            const selectEl = document.getElementById('student-shape-select');
            geometryData.forEach((item, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.text = item.name;
                selectEl.appendChild(option);
            });
        };

        // --- üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Mobile Autoplay) üî• ---
        function speak(text) {
            if (!isSoundOn) return; 
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'th-TH'; // ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            utterance.rate = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        function stopSpeaking() { window.speechSynthesis.cancel(); }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('btn-sound-toggle');
            btn.innerHTML = isSoundOn ? "üîä" : "üîá";
            if(!isSoundOn) stopSpeaking();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πÅ‡∏Å‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
        function unlockAudio() {
            const emptySource = new SpeechSynthesisUtterance("");
            window.speechSynthesis.speak(emptySource);
        }

        function setupARListeners() {
            const arTargets = document.querySelectorAll('[mindar-image-target]');
            arTargets.forEach((target, index) => {
                target.addEventListener("targetFound", event => {
                    // 1. ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°)
                    const model = target.querySelector('a-gltf-model');
                    if(model) {
                        model.removeAttribute('animation__pop');
                        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å
                        const currentScale = model.object3D.scale;
                        model.setAttribute('scale', '0 0 0');
                        // ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏ô‡∏≤‡∏î 0.5
                        setTimeout(() => {
                             model.setAttribute('animation__pop', 'property: scale; from: 0 0 0; to: 0.5 0.5 0.5; dur: 1200; easing: easeOutElastic');
                        }, 50);
                    }
                    // 2. ‡∏û‡∏π‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏ï‡∏£
                    speak(geometryData[index].speech);
                });

                target.addEventListener("targetLost", event => {
                    stopSpeaking(); 
                });
            });
        }

        const youtubeVideoID = "bPyxXEQ7A9M"; 
        function openBookLink() { window.open("https://www.athometh.com/math/geometry/", "_blank"); }
        function openVideoModal() { document.getElementById('youtube-frame').src = `https://www.youtube.com/embed/${youtubeVideoID}?autoplay=1`; document.getElementById('video-modal').style.display = 'flex'; }
        function closeVideoModal() { document.getElementById('youtube-frame').src = ""; document.getElementById('video-modal').style.display = 'none'; }

        function openStudentInputModal() {
            document.getElementById('student-shape-select').value = currentIdx;
            document.getElementById('student-area-input').value = "";
            document.getElementById('student-vol-input').value = "";
            document.getElementById('student-input-modal').style.display = 'flex';
        }
        function closeStudentInputModal() { document.getElementById('student-input-modal').style.display = 'none'; }

        function submitStudentFormulas() {
            const userArea = document.getElementById('student-area-input').value || "(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)";
            const userVol = document.getElementById('student-vol-input').value || "(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)";
            const selectedShapeIndex = parseInt(document.getElementById('student-shape-select').value);
            currentIdx = selectedShapeIndex;
            updateGallery();
            closeStudentInputModal();
            openFormula(userArea, userVol);
            if(document.getElementById('gallery-ui').style.display !== 'none'){ playPopAnimation(); }
        }

        function playPopAnimation() {
            let curr = document.getElementById(`view-m${currentIdx+1}`);
            if(curr) {
                curr.setAttribute('scale', '0 0 0');
                curr.removeAttribute('animation__pop');
                setTimeout(() => {
                    curr.setAttribute('animation__pop', 'property: scale; from: 0 0 0; to: 0.5 0.5 0.5; dur: 1200; easing: easeOutElastic');
                }, 50);
            }
        }

        function openFormula(studentArea = null, studentVol = null) {
            const isStudentInput = studentArea !== null || studentVol !== null;
            let areaText, volText, titleText, descText;
            if (isStudentInput) {
                titleText = "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏û‡∏¥‡∏°‡∏û‡πå (Your Input)";
                areaText = studentArea;
                volText = studentVol;
                descText = "‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≥‡πÑ‡∏î‡πâ (‡∏•‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏â‡∏•‡∏¢‡∏î‡∏π‡∏ô‡∏∞)";
                document.querySelectorAll('.db-edit-btn').forEach(el => el.classList.add('hidden'));
            } else {
                const data = geometryData[currentIdx];
                titleText = data.name;
                areaText = data.area;
                volText = data.vol;
                descText = data.desc;
                document.querySelectorAll('.db-edit-btn').forEach(el => el.classList.remove('hidden'));
                if(!isStudentInput) speak(data.speech);
            }
            document.getElementById('formula-title').innerText = titleText;
            document.getElementById('formula-desc-text').innerHTML = descText;
            document.getElementById(`formula-area-text`).innerHTML = areaText;
            document.getElementById(`formula-volume-text`).innerHTML = volText;
            document.getElementById(`area-display-group`).classList.remove('hidden');
            document.getElementById(`area-edit-group`).classList.add('hidden');
            document.getElementById(`volume-display-group`).classList.remove('hidden');
            document.getElementById(`volume-edit-group`).classList.add('hidden');
            document.getElementById('formula-modal').style.display = 'flex';
        }

        function enableEditMode(type) {
            const data = geometryData[currentIdx];
            let cleanValue = data[type === 'area' ? 'area' : 'vol'].replace(/<sup>/g, '^').replace(/<\/sup>/g, '');
            document.getElementById(`${type}-input`).value = cleanValue;
            document.getElementById(`${type}-display-group`).classList.add('hidden');
            document.getElementById(`${type}-edit-group`).classList.remove('hidden');
        }
        function saveFormula(type) {
            const newValue = document.getElementById(`${type}-input`).value;
            if (type === 'area') { geometryData[currentIdx].area = newValue; } else { geometryData[currentIdx].vol = newValue; }
            openFormula();
        }
        function cancelEdit(type) { openFormula(); }
        function closeFormulaModal() { 
            document.getElementById('formula-modal').style.display = 'none'; 
            stopSpeaking(); 
        }

        function enterGallery() { document.getElementById('intro-screen').style.display = 'none'; document.getElementById('gallery-ui').style.display = 'block'; updateGallery(); }
        function enterMenu() { document.getElementById('intro-screen').style.display = 'flex'; document.getElementById('gallery-ui').style.display = 'none'; }
        function enterARDirectly() { document.getElementById('intro-screen').style.display = 'none'; startAR(); }

        function updateGallery() {
            for(let i=1; i<=7; i++) {
                let el = document.getElementById(`view-m${i}`);
                if(el) el.setAttribute('visible', false);
            }
            let curr = document.getElementById(`view-m${currentIdx+1}`);
            if(curr) curr.setAttribute('visible', true);
            document.getElementById('model-name').innerText = geometryData[currentIdx].name;
        }

        function nextModel() { 
            if(isProcessing) return; 
            stopSpeaking(); 
            currentIdx = (currentIdx + 1) % geometryData.length; 
            updateGallery(); 
        }
        function prevModel() { 
            if(isProcessing) return; 
            stopSpeaking(); 
            currentIdx = (currentIdx - 1 + geometryData.length) % geometryData.length; 
            updateGallery(); 
        }

        async function startAR() {
            if(isProcessing) return;
            if(!arSystem) { alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."); return; }
            
            // üî• ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° üî•
            unlockAudio();

            isProcessing = true; loadingOverlay.style.display = 'flex';
            if(document.getElementById('btn-open-ar')) document.getElementById('btn-open-ar').disabled = true;

            try {
                document.getElementById('intro-screen').style.display = 'none';
                document.getElementById('gallery-ui').style.display = 'none';
                document.getElementById('gallery-group').setAttribute('visible', false);
                document.getElementById('ar-group').setAttribute('visible', true);
                document.getElementById('btn-sound-toggle').style.display = 'block';

                await arSystem.start();
                document.getElementById('ar-ui').style.display = 'block';
                document.getElementById('ar-guide').style.display = 'block';
            } catch(e) {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ");
                document.getElementById('gallery-group').setAttribute('visible', true);
                document.getElementById('gallery-ui').style.display = 'block';
            } finally {
                loadingOverlay.style.display = 'none';
                if(document.getElementById('btn-open-ar')) document.getElementById('btn-open-ar').disabled = false;
                isProcessing = false;
            }
        }
        function stopAR() { window.location.reload(); }
    </script>
</body>
</html>